最終ゴール（Router を main/ に分離し、shared/ をユニバーサル層にする）へ向け、
**“手で動かして確認できる最小粒度”**で 15 ステップに分割しました。
各ステップ後に pnpm run typecheck → pnpm run dev を実行し、
型エラーゼロ & アプリが起動することを確認してください。

⸻

実装ステップ

# 作業内容 追加ライブラリ 完了チェック

1 安全ブランチを切るgit checkout -b refactor/adr-0005 – git status に新ブランチ
2 ユニバーサル層を作成mkdir -p src/shared/domain – フォルダが出来る
3 Todo & Theme スキーマを移設 _ git mv src/shared/trpc.ts src/shared/domain/todo-theme.ts _ そのファイルから @trpc/server/Router 関連を削除 – pnpm run typecheck が通る
4 Runtime 定数ファイル追加src/shared/constants.ts に THEME_OPTIONS, DEFAULT_THEME を定義 – pnpm run typecheck
5 バレルを作成src/shared/index.ts にexport _ from "./domain/todo-theme";export _ from "./constants"; – アプリ起動
6 Renderer の型インポートを更新src/renderer/\*_/_.ts(x) でfrom "../../shared/trpc" → from "#shared"値を使わない場合は import type に置換 – pnpm run typecheck
7 tsconfig.web.json に alias 追加"#shared/_": ["src/shared/_"]"importsNotUsedAsValues": "error" – pnpm run typecheck
8 Router 専用ディレクトリ作成mkdir -p src/main/trpc – フォルダ確認
9 Router コードを新ファイルへ移動src/main/trpc/router.ts を作成し、旧 appRouter・publicProcedure をコピー – pnpm run typecheck
10 Main 側 tsconfig 更新tsconfig.node.json に"#shared/_": ["src/shared/_"], "#main/_": ["src/main/_"] を追加 – 型チェック
11 IPC アダプタの import を変更src/main/trpc-ipc-adapter.ts でimport { appRouter } from "#main/trpc/router"; – アプリ起動し Todo 取得可能
12 Renderer クライアントの型参照を修正src/renderer/lib/trpc.tsimport type { AppRouter } from "#main/trpc/router"; – 型チェック
13 Vite エイリアスを設定electron.vite.config.ts の resolve.alias に{ '#shared': path.resolve('src/shared'), '#main': path.resolve('src/main') } – pnpm run dev で動作
14 Node-only deps を外部化Vite build 設定に external: ["@trpc/server","electron","fs"] を追加 – pnpm run build で @trpc/server がバンドルされない
15 ESLint ガード追加no-restricted-imports で @trpc/server を禁止 & @typescript-eslint/consistent-type-imports を error – pnpm run lint で違反ゼロ

⸻

参考にした公式ドキュメント & ガイド
• Node "imports" の # プライベート指定子 ￼
• TypeScript paths 設定 ￼
• Vite の resolve.alias 設定 ￼
• Electron Context Isolation / contextBridge ￼
• tRPC で Router をサーバ側に分離するベストプラクティス ￼
• ESLint no-restricted-imports ルール ￼
• インクリメンタルリファクタリングの考え方 ￼
• pnpm run コマンド仕様 ￼
• esbuild external オプション解説 ￼
• Import Maps 仕様での # 予約接頭辞 ￼

⸻

メモ
• YAGNI を徹底するため、各ステップでは 絶対に不要なコードや依存を追加しない。
• エラーが出たら git restore -s@{-1} で直前コミットに戻し、必ず緑にしてから次へ。
• もしステップ途中で UI が壊れた場合は、そのステップだけ をロールバックし原因を特定。

これで、毎ステップ確実に動作を確認しながら安全に ADR-0005 へ移行できます。
